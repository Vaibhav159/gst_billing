<tr class="bg-gray-50" id="line-item-form-{{ total_line_items|add:1 }}">
    <td colspan="8">
        <form class="p-4 space-y-4"
              hx-post="{% url 'line_item_add' %}"
              hx-target="#line-item-form-{{ total_line_items|add:1 }}"
              hx-swap="outerHTML">
            
            <input type="hidden" name="invoice_id" value="{{ invoice_id }}">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Product Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Product</label>
                    <select name="item_name" 
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">Select Product</option>
                        {% for product in product_list %}
                            <option value="{{ product.name }}">{{ product.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Quantity + Unit -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Quantity</label>
                    <div class="mt-1 flex space-x-2">
                        <input type="number" 
                               name="qty" 
                               id="line-item-qty"
                               step="0.001"
                               class="flex-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                               required>
                        <select name="unit" id="line-item-unit"
                                class="w-28 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="gm" selected>g</option>
                            <option value="kg">kg</option>
                            <option value="pcs">pc</option>
                        </select>
                    </div>
                </div>

                <!-- Rate -->
                <div>
                    <label class="block text-sm font-medium text-gray-700"><span id="line-item-rate-label">Rate (₹/g)</span></label>
                    <input type="number" 
                           name="rate" 
                           id="line-item-rate"
                           step="0.001"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                           required>
                </div>
            </div>

            <script>
                (function(){
                    const unitSelect = document.getElementById('line-item-unit');
                    const rateLabel = document.getElementById('line-item-rate-label');

                    function updateRateLabel() {
                        const u = unitSelect.value;
                        if (u === 'gm') rateLabel.textContent = 'Rate (₹/g)';
                        else if (u === 'kg') rateLabel.textContent = 'Rate (₹/kg)';
                        else rateLabel.textContent = 'Rate (₹/pc)';
                    }

                    if (unitSelect) {
                        unitSelect.addEventListener('change', updateRateLabel);
                        // initialize on DOM load (in case included via HTMX)
                        updateRateLabel();
                    }
                })();
            </script>

            <div class="flex justify-end space-x-3">
                <button type="button"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
                        onclick="this.closest('tr').remove()">
                    Cancel
                </button>
                <button type="submit"
                        class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">
                    Add Item
                </button>
            </div>
        </form>
    </td>
</tr>
